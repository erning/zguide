<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Zero-Copy</title><meta name="generator" content="DocBook XSL Stylesheets V1.76.1" /><link rel="home" href="index.html" title="The ZeroMQ Guide - for C Developers" /><link rel="up" href="ch02.html" title="Chapter 2. Sockets and Patterns" /><link rel="prev" href="ch02s08.html" title="Node Coordination" /><link rel="next" href="ch02s10.html" title="Pub-Sub Message Envelopes" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Zero-Copy</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch02s08.html">Prev</a> </td><th width="60%" align="center">Chapter 2. Sockets and Patterns</th><td width="20%" align="right"> <a accesskey="n" href="ch02s10.html">Next</a></td></tr></table><hr /></div><div class="sect1" title="Zero-Copy"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="idp19327176"></a>Zero-Copy</h2></div></div></div><p>ØMQ's message API lets you can send and receive messages directly from and to application buffers without copying data. We call this <span class="emphasis"><em>zero-copy</em></span>, and it can improve performance in some applications.</p><p>You should think about using zero-copy in the specific case where you are sending large blocks of memory (thousands of bytes), at a high frequency. For short messages, or for lower message rates, using zero-copy will make your code messier and more complex with no measurable benefit. Like all optimizations, use this when you know it helps, and <span class="emphasis"><em>measure</em></span> before and after.</p><p>To do zero-copy, you use <code class="literal">zmq_msg_init_data()</code> to create a message that refers to a block of data already allocated with <code class="literal">malloc()</code> or some other allocator, and then you pass that to <code class="literal">zmq_msg_send()</code>. When you create the message, you also pass a function that ØMQ will call to free the block of data, when it has finished sending the message. This is the simplest example, assuming <code class="literal">buffer</code> is a block of 1,000 bytes allocated on the heap:</p><pre class="programlisting">
void my_free (void *data, void *hint) {
    free (data);
}
//  Send message from buffer, which we allocate and 0MQ will free for us
zmq_msg_t message;
zmq_msg_init_data (&amp;message, buffer, 1000, my_free, NULL);
zmq_msg_send (&amp;message, socket, 0);
</pre><p>Note that you don't call <code class="literal">zmq_msg_close()</code> after sending a message--<code class="literal">libzmq</code> will do this automatically when it's actually done sending the message.</p><p>There is no way to do zero-copy on receive: ØMQ delivers you a buffer that you can store as long as you wish, but it will not write data directly into application buffers.</p><p>On writing, ØMQ's multipart messages work nicely together with zero-copy. In traditional messaging, you need to marshal different buffers together into one buffer that you can send. That means copying data. With ØMQ, you can send multiple buffers coming from different sources as individual message frames. Send each field as a length-delimited frame. To the application, it looks like a series of send and receive calls. But internally, the multiple parts get written to the network and read back with single system calls, so it's very efficient.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch02s08.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="ch02.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="ch02s10.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Node Coordination </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Pub-Sub Message Envelopes</td></tr></table></div></body></html>
